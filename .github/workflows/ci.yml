name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # ── Checkout the repo ───────────────────────────────────────────────
      - uses: actions/checkout@v4

      # ── Set up Python, install your ATO-CLI in editable mode ────────────
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package + pytest
        run: |
          python -m pip install --upgrade pip
          pip install -e .      # uses the pyproject at repo root
          pip install pytest

      # ── Run the unit tests ──────────────────────────────────────────────
      - name: Run tests
        run: pytest -q tests

      # ── Run your scanner to generate an OSCAL file ──────────────────────
      - name: Generate OSCAL
        run: |
          ato-scan -i ato_cli -o ci_report --quiet

      - name: List all files for debugging
        run: |
          ls -lR

      - name: OSCAL CLI version
        run: |
          docker run --rm ghcr.io/gsa/fedramp-automation/validation-tools:latest --version

      - name: Validate OSCAL SSP
        run: |
          docker run --rm -v ${{ github.workspace }}:/data ghcr.io/gsa/fedramp-automation/validation-tools:latest ssp validate /data/ci_report/ci_report_oscal.json

      - name: Show OSCAL file contents
        run: |
          head -40 ci_report/ci_report_oscal.json

      - name: List files for debugging
        run: |
          ls -lR ci_report